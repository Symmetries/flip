var APP = APP || {};

APP.update = function(state, input){
    if (state.level < 0){
        return newState(0);
    } else {
        if (input === "l"){
            state.angle += Math.PI/256;
        } else if (input === "r"){
            state.angle -= Math.PI/256;
        }
        state.x += 0.01 * Math.cos(state.angle);
        state.y += 0.01 * Math.sin(state.angle);
    } 
    var current = state.maps[state.level][Math.floor(state.x)][Math.floor(state.y)];
    if (current === "#"){
        return newState(state.level);
    } else if (current === "="){
        return newState(state.level + 1);
    }
    return state;
};

var strMaps = [//1
              "#######|" +
              "#.....#|" +
              "#@...=#|" + 
              "#.....#|" +
              "#######|",
              //2
              "#######|" +
              "#....=#|" +
              "#@....#|" +
              "#.....#|" +
              "#######|",
              //3
              "#######|" +
              "#.....#|" +
              "#@....#|" +
              "#....=#|" +
              "#######|",
              //4
              "########|" +
              "#......#|" +
              "#@..#.=#|" +
              "#......#|" +
              "########|",
              //5
              "#######|" +
              "#@....#|" +
              "#####=#|" +
              "#######|",
              //6
              "######|" +
              "####=#|" +
              "####.#|" +
              "#@...#|" +
              "######|",
              //7
              "########|" +
              "#@.....#|" +
              "######.#|" +
              "######.#|" +
              "######=#|" +
              "########",
              //8
              "#######|" +
              "###...#|" +
              "#@..#=#|" +
              "#######|",
              //9
              "#######|" +
              "#@..#=#|" +
              "###...#|" +
              "#######|",
              //10
              "#####|" +
              "#@..#|" +
              "###.#|" +
              "#=..#|" +
              "#####|",
              //11
              "######|" +
              "#....#|" +
              "#.##.#|" +
              "#=#@.#|" +
              "######|",
              //12
              "#######|" +
              "###...#|" +
              "#=@.#.#|" +
              "###...#|" +
              "#######|",
              //13
              "#####|" +
              "#..=#|" +
              "#.###|" +
              "#...#|" +
              "###.#|" +
              "#@..#|" +
              "#####|",
              //14
              "######|" +
              "##=#.#|" +
              "##.#.#|" +
              "#@...#|" +
              "######|",
              //15
              "###########|" +
              "###.....###|" +
              "###.#...###|" +
              "###.#=..###|" +
              "###.###.###|" +
              "#@......###|" +
              "###########|",
              //16
              "###########|" +
              "#######..=#|" +
              "#######.#.#|" +
              "###.......#|" +
              "###.#.#.###|" +
              "###.....###|" +
              "###.#.#.###|" +
              "#@......###|" +
              "###########|",
              //17
              "#########|" +
              "#...#####|" +
              "#.#.#####|" +
              "#.......#|" +
              "#######.#|" +
              "#=@.....#|" +
              "#########|",
              //18
              "#######|" +
              "#.....#|" +
              "#.###.#|" +
              "#.#@..#|" +
              "#.#####|" +
              "#....=#|" +
              "#######|",
              //19
              "#######|" +
              "#.....#|" +
              "#.###.#|" +
              "#..=#.#|" +
              "#.###.#|" +
              "#@....#|" +
              "#######|",
              //20
              "###########|" +
              "#.......#=#|" +
              "#.#####.#.#|" +
              "#.#...#...#|" +
              "#...#.#####|" +
              "#####.....#|" +
              "#@..###.#.#|" +
              "###.......#|" +
              "###########|"];
              


// strMap1 = ".......|" +
//           ".......|" +
//           "#######|" +
//           "#=...##|" +
//           "####.##|" +
//           "..##=##|" +
//           "..#####|";


var strToMap = function(strMap){
    var row = [];
    var res = [];
    for(var i = 0; i < strMap.length; i++){
        if (strMap.charAt(i) === "|"){
            res.push(row);
            row = [];
        } else{
            row.push(strMap.charAt(i));
        }
    }
    return res;
};

var maps = [];

var coords = function(map){
    for (var i = 0; i < map.length; i++){
        for (var j = 0; j < map[i].length; j++){
            if (map[i][j] === "@"){
                return {x: i  + 0.5, y: j + 0.5};
            }
        }
    }
};


for (var i = 0; i < strMaps.length; i++){
    maps.push(strToMap(strMaps[i]));
}

var newState = function(level){
    var pos = coords(maps[level]);
    return {level:level, maps:maps, x:pos.x, y:pos.y, angle: Math.PI/2};
};